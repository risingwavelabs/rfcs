---
feature: Stream Executor with Emit on Close Semantics
authors:
  - "st1page"
start_date: "2023/02/14"
---

# Stream Executor with Emit on Close Semantics 

## Summary

Introduce a new component Sort Buffer used in the streaming executor and give a general method to implement EMIT ON CLOSE stream executor. Sort Buffer can support materialize and persistent the changes stream and drain the "stable" records with the input watermark. Because the input watermarks is always monotonically increasing, the output records is ordered by the watermark column and append-only. The component is very useful with EMIT ON WINDOW CLOSE Semantics([RFC: The Semantics of EMIT ON WINDOW CLOSE](https://github.com/risingwavelabs/rfcs/pull/30)).

***Note: In this RFC, we will focus on the EMIT ON CLOSE query***

## Background and Definitions 
Let's look back on the current designs and RFCs. 

The [RFC: The Semantics of EMIT ON WINDOW CLOSE](https://github.com/risingwavelabs/rfcs/pull/30) has give a strict definition on the semantics of **EMIT ON WINDOW CLOSE**. In short, the streaming job with "EMIT ON CLOSE" modifier emits the result when the result is complete, and no sooner, no later. In other word the "EMIT ON CLOSE" streaming query give a append only result as soon as possible.

According to the same RFC(EMIT ON CLOSE), The **User-defined Watermark** on the source make user have a way to declare which records from the source is outdated and can be discarded. Watermark give a bound of the data as the data inputs, which provides guarantee that some results are complete and triggers the emitting of the EMIT ON CLOSE query.

And [RFC: The WatermarkFilter and StreamSort operator](https://github.com/risingwavelabs/rfcs/pull/2) introduces the WatermarkFilter stream operator. With the "user-defined watermark" and continuous ingested data, WatermarkFilter can generate consistent **Internal Watermark Stream Message** (hereinafter referred to as **"Watermark"** or **"Watermark message"**). A Watermark message with column index and value means there will be no data have larger watermark column value than the value in the watermark.

Also the RFC propose the **Watermark Derivation** of the stream operator. This design make sure that all possible trigger message generated by **User-defined Watermark** can be expressed as the **Watermark message**. The only thing can transfer between
the stream operator is the Watermark message, so that the stream operator does not need to be aware of the "time window" or other concept. The executor just need to handle the input watermark no matter whether the watermark column is a "window_close" or a temporal filter's output column.

And then we can introduce **EMIT ON CLOSE Flag** on any stream operator now. The stream operator with the flag works can make sure some result is complete with the input watermark and then emit them. Obviously, if the most downstream stream operator has EMIT ON CLOSE Flag, the streaming query can satisfy the EMIT ON WINDOW CLOSE semantics. 

In this RFC, we will focus on how to implement stream executor with EMIT ON WINDOW CLOSE flag and reuse the logic of the normal stream executor.

## Sort Buffer Design

### Streaming Agg

## Unresolved questions

* Are there some questions that haven't been resolved in the RFC?
* Can they be resolved in some future RFCs?
* Move some meaningful comments to here.

## Alternatives

What other designs have been considered and what is the rationale for not choosing them?

## Future possibilities

Some potential extensions or optimizations can be done in the future based on the RFC.
